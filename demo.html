<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>directio</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        body {
            margin: 0;
            font-family: sans-serif;
        }

        #controls {
            padding: 10px;
            background: #f5f5f5;
        }

        #map {
            height: calc(100vh - 60px);
        }

        input {
            width: 70%;
            padding: 6px;
        }

        button {
            padding: 6px 10px;
        }
    </style>
</head>

<body>

    <div id="controls">
        <input id="query" type="text" placeholder="Where can I eat ramen near Sudirman Jakarta?" />
        <button onclick="sendQuery()">Search</button>
    </div>

    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const GET_API_URL = "http://127.0.0.1:8000/keys";
        const API_URL = "http://127.0.0.1:8000/chat";

        const EMAIL = "user1@example.com";

        const map = L.map("map").setView([-6.2, 106.8], 13);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "&copy; OpenStreetMap contributors",
        }).addTo(map);

        let layerGroup = L.layerGroup().addTo(map);

        function getStoredApiKey() {
            return sessionStorage.getItem("directio_api_key");
        }

        function clearStoredApiKey() {
            sessionStorage.removeItem("directio_api_key");
        }

        function storeApiKey(key) {
            sessionStorage.setItem("directio_api_key", key);
        }

        async function ensureApiKey() {
            let apiKey = getStoredApiKey();
            if (apiKey) {
                return apiKey;
            }

            const resp = await fetch(GET_API_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ email: EMAIL }),
            });

            if (!resp.ok) {
                const err = await resp.json();
                throw new Error(err.detail || "Failed to create API key");
            }

            const data = await resp.json();
            storeApiKey(data.api_key);
            return data.api_key;
        }

        async function sendQuery(retry = true) {
            const query = document.getElementById("query").value;
            if (!query) return;

            layerGroup.clearLayers();

            let apiKey = await ensureApiKey();

            let resp = await fetch(API_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-API-Key": apiKey,
                },
                body: JSON.stringify({ message: query }),
            });
            console.log(resp.status)

            // ðŸ” API key expired / server restarted
            if (resp.status === 401 && retry) {
                clearStoredApiKey();
                apiKey = await ensureApiKey();
                return sendQuery(false); // retry once
            }

            const data = await resp.json();

            if (data.intent === "find_places") {
                renderPlaces(data.places);
            }

            if (data.intent === "get_directions") {
                renderRoute(data.route.geometry);
            }
        }

        function renderPlaces(places) {
            const bounds = [];

            places.forEach((p) => {
                const marker = L.marker([p.lat, p.lon])
                    .bindPopup(`<b>${p.name}</b><br>${p.address}`)
                    .addTo(layerGroup);

                bounds.push([p.lat, p.lon]);
            });

            if (bounds.length) {
                map.fitBounds(bounds, { padding: [40, 40] });
            }
        }

        function renderRoute(geometry) {
            const route = L.geoJSON(geometry, {
                style: {
                    color: "blue",
                    weight: 5,
                },
            }).addTo(layerGroup);

            map.fitBounds(route.getBounds(), { padding: [40, 40] });
        }
    </script>

</body>

</html>